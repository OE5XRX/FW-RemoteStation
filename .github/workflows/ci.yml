name: CI

on:
  pull_request:
  push:
    branches: main

jobs:
  clang_format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format-18
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18
          sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-18 180
          clang-format --version

      - name: clang-format check
        shell: bash
        run: |
          set -euo pipefail
          PATHS=("app" "boards" "tests")
          mapfile -t FILES < <(
            find "${PATHS[@]}" -type f \( \
              -name "*.c" -o -name "*.h" \
              -o -name "*.cc" -o -name "*.hh" \
              -o -name "*.cpp" -o -name "*.hpp" \
            \) -print
          )
          [ "${#FILES[@]}" -eq 0 ] && exit 0
          clang-format -i "${FILES[@]}"
          git diff --quiet || (echo "::error::clang-format produced changes"; git --no-pager diff --name-only; exit 1)

  build_and_tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: fw

      - name: Setup Zephyr
        uses: zephyrproject-rtos/action-zephyr-setup@v1
        with:
          app-path: fw
          toolchains: arm-zephyr-eabi

      - name: West sanity
        shell: bash
        run: |
          set -euo pipefail
          west --version
          west list

      - name: Build native_sim
        working-directory: fw
        shell: bash
        run: |
          set -euo pipefail
          west build -b native_sim/native/64 app -p always

      - name: Twister integration build (app/)
        working-directory: fw
        shell: bash
        run: |
          set -euo pipefail
          west twister -T app --integration -v --inline-logs

      - name: Twister system tests (shell)
        working-directory: fw
        shell: bash
        run: |
          set -euo pipefail
          west twister -T tests/sim_shell -p native_sim/native/64 -v --inline-logs

#      - name: Twister unit tests
#        working-directory: fw
#        shell: bash
#        run: |
#          set -euo pipefail
#          west twister -T tests/unit_audio -p native_sim/native/64 -v --inline-logs
